{% extends "base_init.html" %}
{% load widget_tweaks %}
{% load static %}

{% load widget_tweaks %}







{% block content %}



<div class="page-content-wrapper">
          <!-- start page content-->
         <div class="page-content">

          




<div class="row">
  <div class="col-lg-8 mx-auto">

    <div class="card radius-10">
      <div class="card-body" style="background-color: #9e191b;">

           
        <form method="POST" enctype="multipart/form-data">
          {% csrf_token %}

     <div class="row mb-4 align-items-start">
  
  <!-- Columna izquierda: Foto y botón -->
  <div class="col-md-4 d-flex flex-column align-items-center">
    <div class="user-change-photo shadow mb-3">
      {% if profile.photo %}
        <img src="{{ profile.photo.url }}" alt="Foto de Perfil"
             class="img-fluid rounded-circle"
             style="width: 155px; height: 155px; object-fit: cover;">
      {% else %}
        <img src="{% static 'assets/images/login_bg/Sello2.png' %}" alt="Foto por defecto"
             class="img-fluid rounded-circle"
             style="width: 155px; height: 129px; object-fit: cover;">
      {% endif %}
    </div>

    <!-- Campo oculto -->
    <div>
      {{ form.photo|add_class:"d-none"|attr:"id:id_photo" }}
    </div>

    <button type="button" id="btnCambiarFoto" class="btn btn-outline-primary btn-sm radius-30 px-4">
     <ion-icon name="person-circle-outline"></ion-icon> Selecione su foto de perfil
    </button>
  </div>

  <!-- Columna derecha: AI Agent -->
  <div class="col-md-8">
    <h4 class="display-4 mt-3"><ion-icon name="chatbox-ellipses-outline"></ion-icon> AI Agent SmartQuail, Inc</h4>
    <p id="typewriter" style="color:#fff;">
      
    </p>

  </div>

</div>

          <!-- ======================= -->
          <!--   DATOS PERSONALES      -->
          <!-- ======================= -->
          <hr>

          <div class="row g-3">

            <div class="col-12">
              <label class="form-label">Escriba su nombre completo</label>
              {{ form.nombre_completo }}
            </div>


            <div class="col-6">
              <label class="form-label">Nombre del Proyecto</label>
              {{ form.nombre_empresa }}
            </div>

            <div class="col-6">
              <label class="form-label">Cargo en la Proyecto</label>
              {{ form.cargo_usuario }}
            </div>

            <div class="col-6">
              <label class="form-label">Sector de Negocio</label>
              {{ form.sector_negocio }}
            </div>

                        <div class="col-6">
              <label class="form-label">Tamaño de la Empresa</label>
              {{ form.tamano_empresa }}
            </div>

             <div class="col-6">
              <label class="form-label">Nivel de Experiencia</label>
              {{ form.nivel_experiencia_cloud }}
            </div>

             <div class="col-6">
              <label class="form-label">Presupuesto Estimado</label>
              {{ form.presupuesto_estimado }}
            </div>


          </div>

          <!-- ========================= -->
          <!--   INFORMACIÓN EMPRESARIAL -->
          <!-- ========================= -->

          <hr>




          <!-- BOTÓN GUARDAR -->
<div class="text-start mt-3 d-flex gap-3">
  <a href="{% url 'usuarios:logout' %}" class="btn btn-outline-primary px-4">
    <ion-icon name="log-out-outline"></ion-icon> Cerrar Sesión
  </a>

  <button type="submit" class="btn btn-outline-primary px-4">
    Continuar <ion-icon name="arrow-forward-outline"></ion-icon>
  </button>
</div>


        </form>
      </div>
    </div>

  </div>
</div>



  </div>



</div>


             


<script>
document.addEventListener("DOMContentLoaded", function () {

    const btnCambiarFoto = document.querySelector("#btnCambiarFoto");
    const inputPhoto = document.querySelector("#id_photo");
    const previewImg = document.querySelector("#previewPhoto");

    // Botón que llama al input oculto
    btnCambiarFoto.addEventListener("click", function () {
        inputPhoto.click();
    });

    // Vista previa de la imagen seleccionada
    inputPhoto.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
                previewImg.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

});
</script>





<script>
document.addEventListener("DOMContentLoaded", function () {

    function typeWriterEffect(elementId, text, speed) {
        let index = 0;
        function type() {
            if (index < text.length) {
                document.getElementById(elementId).innerHTML += text.charAt(index);
                index++;
                setTimeout(type, speed);
            }
        }
        type();
    }

   
    const text_start = `Hola, soy el agente de IA de SmartQuail. Para brindarte acceso a nuestras demostraciones y ayudarte a explorar los aspectos técnicos y tecnológicos de nuestros productos, necesitamos conocer un poco más sobre tus necesidades e iniciativas o proyectos de negocio tecnológico.

Te invitamos cordialmente a completar el siguiente formulario. ¡Gracias por tu interés!`;
    typeWriterEffect("typewriter", text_start, 35);


});
</script>



<script>
function typeWriterEffect(elementId, text, speed = 35) {
    let index = 0;
    const target = document.getElementById(elementId);

    function write() {
        if (index < text.length) {
            target.innerHTML += text.charAt(index);
            index++;
            setTimeout(write, speed);
        }
    }
    write();
}
</script>







<script>
document.addEventListener("DOMContentLoaded", function () {

    const terminal = document.getElementById("terminal-output");
    const prefix = "# ";

    // Función para colorear según tipo
    function colorize(line, element) {
        if (line.includes("[SUCCESS]")) element.style.color = "#00ff5e";        // VERDE
        else if (line.includes("[INFO]")) element.style.color = "#ffd54f";      // AMARILLO
        else if (line.includes("[OK]")) element.style.color = "#6dffea";        // VERDE CIAN
        else if (line.includes("[SECURITY]")) element.style.color = "#9c7bff";  // MORADO
        else if (line.includes("[SYSTEM]")) element.style.color = "#6ecbff";    // CELESTE
        else if (line.includes("[RESOURCE]")) element.style.color = "#4fe3ff";  // CIAN SUAVE
        else element.style.color = "#ffffff";                                   // DEFAULT
    }

    // BLOQUES DE LOGS POR PORCENTAJE
    const logs_by_progress = [
        { min: 10, logs: [
            prefix + "[RESOURCE] Analizando requerimientos de carga del proyecto IT Cloud Business... (1.4s)",
            prefix + "[RESOURCE] Estimando consumo inicial: 2 vCPU, 4GB RAM, 40GB SSD. (214ms)",
            prefix + "[RESOURCE] Predicción IA: carga media proyectada a 90 días: 3.2 vCPU, 6GB RAM. (538ms)",
            prefix + "[RESOURCE] Evaluando proveedores según latencia...",
            prefix + "[RESOURCE] Latencia promedio detectada:",
            prefix + "          AWS Frankfurt: 23ms",
            prefix + "          Azure Zurich: 28ms",
            prefix + "          Google Cloud Bélgica: 19ms",
            prefix + "          Oracle Amsterdam: 31ms",
            prefix + "[OK]  Proveedor con mejor tiempo: Google Cloud (19ms).",
            prefix + "[RESOURCE] Analizando costos estimados por proveedor... (732ms)",
            prefix + "          AWS: $38.12/mes",
            prefix + "          Azure: $41.55/mes",
            prefix + "          GCP: $33.74/mes",
            prefix + "          Oracle: $36.90/mes",
            prefix + "[OK]  Proveedor más eficiente: Google Cloud (GCP).",
            prefix + "[RESOURCE] Verificando disponibilidad regional de GCP... (1.1s)",
            prefix + "[OK]  Región disponible: europe-west1 (Bélgica).",
            prefix + "[RESOURCE] Consultando inventario de máquinas virtuales... (482ms)",
            prefix + "[RESOURCE] Tipos disponibles:",
            prefix + "          e2-medium: 2 vCPU / 4GB RAM",
            prefix + "          e2-standard-2: 2 vCPU / 8GB RAM",
            prefix + "          n2-standard-2: 2 vCPU / 8GB RAM (alto rendimiento)",
            prefix + "[INFO] Comparando rendimiento/costo con predictor IA... (806ms)",
            prefix + "[OK]  Recurso ideal: e2-standard-2 (balance costo-rendimiento).",
            prefix + "[RESOURCE] Verificando disponibilidad de almacenamiento SSD... (412ms)",
            prefix + "[OK]  Disco persistente 40GB listo para aprovisionamiento.",
            prefix + "[SUCCESS] Recurso ideal seleccionado: GCP europe-west1 / e2-standard-2 (2 vCPU, 8GB RAM).",
            prefix + "[SYSTEM] Iniciando aprovisionamiento del recurso seleccionado... (in progress)"
        ]},
        { min: 15, logs: [
            prefix + "[SECURITY] Evaluando cumplimiento normativo según región: GDPR, ISO-27001, SOC2... (1.5s)",
            prefix + "[OK]  Región seleccionada cumple todas las normativas aplicables.",
            prefix + "[RESOURCE] Evaluando redes y balanceadores de carga... (1.3s)",
            prefix + "[OK]  VPC dinámica y load balancer disponibles en región seleccionada.",
            prefix + "[RESOURCE] Verificando capacidad para escalamiento automático (autoscaling)... (662ms)",
            prefix + "[OK]  Autoscaling horizontal configurable de 2 a 10 instancias.",
            prefix + "[RESOURCE] Evaluando redundancia multi-zona...",
            prefix + "[OK]  Zonas activas: europe-west1-b, europe-west1-c.",
            prefix + "[SECURITY] Iniciando protocolo Zero-Trust Network Access (ZTNA)... (1.1s)",
            prefix + "[SECURITY] Cargando políticas IAM de usuario y servicio... (643ms)",
            prefix + "[SECURITY] Validando integridad de tokens JWT... (137ms)",
            prefix + "[SECURITY] Rotando claves de acceso dinámicas... (328ms)",
            prefix + "[OK]  Políticas de seguridad activas y verificadas."
        ]},
        { min: 25, logs: [
            prefix + "[INFO] Iniciando servicio NGINX... (590ms)",
            prefix + "[INFO] Cargando configuración /etc/nginx/nginx.conf... (204ms)",
            prefix + "[SECURITY] Habilitando TLS 1.3 y HTTP/3 QUIC... (376ms)",
            prefix + "[OK]  Certificado SSL cargado: Let's Encrypt R3. (82ms)",
            prefix + "[OK]  NGINX iniciado en el puerto 80 y 443."
        ]},
        { min: 50, logs: [
            prefix + "[INFO] Inicializando base de datos PostgreSQL... (1.7s)",
            prefix + "[INFO] Cargando extensión pgcrypto... (122ms)",
            prefix + "[INFO] Aplicando migraciones automáticas... (3.1s)",
            prefix + "[SECURITY] Activando cifrado en reposo (AES-256)... (288ms)",
            prefix + "[OK]  PostgreSQL listo y escuchando en el puerto 5432.",
            prefix + "[INFO] Verificando replicación... (932ms)",
            prefix + "[OK]  Replicación síncrona activa."
        ]},
        { min: 75, logs: [
            prefix + "[INFO] Iniciando broker Kafka... (1.4s)",
            prefix + "[INFO] Sincronizando particiones... (982ms)",
            prefix + "[SECURITY] Habilitando cifrado TLS para tráfico de brokers... (319ms)",
            prefix + "[OK]  Kafka broker activo en puerto 9092.",
            prefix + "[INFO] Creando topics de streaming... (221ms)",
            prefix + "[OK]  Topic: sq_stream_events creado.",
            prefix + "[OK]  Topic: sq_background_tasks creado."
        ]},
        { min: 100, logs: [
            prefix + "[INFO] Iniciando servidor Redis... (680ms)",
            prefix + "[INFO] Cargando configuraciones de caché...",
            prefix + "[SECURITY] Activando autenticación REDIS ACL... (120ms)",
            prefix + "[OK]  Redis en ejecución: modo cluster-enabled.",
            prefix + "[INFO] Estableciendo TTL inteligente para sesiones... (94ms)",
            prefix + "[OK]  Caché funcional."
        ]}
    ];

    let block_index = 0;
    let line_index = 0;

    function writeLogsByProgress() {
        if (block_index >= logs_by_progress.length) return;

        const block = logs_by_progress[block_index];

        // Solo mostrar bloque si project.progress alcanza el mínimo
        if ({{ project.progress }} >= block.min) {
            if (line_index < block.logs.length) {
                const line = document.createElement("p");
                line.classList.add("mb-0");
                line.textContent = block.logs[line_index];
                colorize(block.logs[line_index], line);

                terminal.appendChild(line);
                terminal.scrollTop = terminal.scrollHeight;

                line_index++;
                setTimeout(writeLogsByProgress, Math.random() * 500 + 300);
            } else {
                block_index++;
                line_index = 0;
                writeLogsByProgress();
            }
        }
    }

    writeLogsByProgress();

});
</script>






{% endblock %}


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<div class="page-content-wrapper">
    <!-- start page content-->
   <div class="page-content">
    <div class="row">
        <div class="col-12 col-lg-8 col-xl-9">


  




            <div class="card-body">
              <div class="mt-5 d-flex align-items-start justify-content-between">
                <div class="">
                  <h3 class="mb-2">Bienvenido {{ profile.user.first_name }} {{ profile.user.last_name }} a SmartQuail,Tech</h3>
                  <p class="mb-2" style ="margin-top:-15px;">Somos tu Industria tecnologica</p>    
                   <p class="mb-1"><strong>{{ profile.institucion|default:"Particular" }}</strong></p>  
                  <p class="mb-0"><strong>{{ profile.tipos|join:" + " }}</strong></p>            
                </div>
              </div>
            </div>

            

            



</div>


<div class="row row-cols-1 row-cols-lg-3 g-3"> <!-- g-3 agrega espacio uniforme entre tarjetas -->

{% if ultima_tarea_pendiente and ultima_tarea_enviada.media_terapia %}
<div class="col">
    <div class="card radius-10 bg-primary text-white h-100">
        <div class="card-body text-left">
            <div class="d-flex align-items-center mb-3 justify-content-center">
                <div class="service-box bg-white text-white me-2">
                    <div class="font-22">
                        <ion-icon name="pulse-outline"></ion-icon>
                    </div>
                </div>
                <h6 class="mb-0 border-bottom">Actividad Terapéutica</h6>
            </div>

            <div class="position-relative d-inline-block">
                <a href="{{ ultima_tarea_enviada.media_terapia.url }}" target="_blank">
                    <img id="thumbnailPreview"
                         src="{{ ultima_tarea_enviada.thumbnail_url|default:'https://via.placeholder.com/160x160.png?text=Video' }}"
                         alt="Previsualización del video"
                         class="img-fluid rounded-circle shadow"
                         style="width: 160px; height: 160px; object-fit: cover;">

                    <div class="position-absolute top-50 start-50 translate-middle">
                        <span class="bg-white text-secondary rounded-circle p-2 shadow" style="font-size: 1.5rem;">
                            <i class="bi bi-play-fill"></i>
                        </span>
                    </div>
                </a>
            </div>

            <div class="mt-3 pt-2 border-top">
                <p class="mb-0">Realizado:
                    <strong>{{ ultima_tarea_enviada.fecha_actividad|date:"d/m/Y H:i" }}</strong>
                </p>
                <p class="mb-0"><strong>Terapeuta Responsable:</strong>
                    Dr. {{ ultima_tarea_enviada.terapeuta.get_full_name|default:"No asignado" }}
                </p>
                <p class="mb-0"><strong>Lugar:</strong>
                    {{ ultima_tarea_enviada.sucursal|default:"No especificado" }}
                </p>
                <p class="mb-0"><strong>Actividad:</strong>
                    {{ ultima_tarea_enviada.descripcion_actividad|safe }}
                </p>
            </div>
        </div>
    </div>
    <video id="hiddenVideo" src="{{ ultima_tarea_enviada.media_terapia.url }}" style="display: none;"></video>
</div>
{% endif %}


    {% if ultima_cita %}
<div class="col">
    <div class="card radius-10 bg-primary text-white h-100">
        <div class="card-body">
            <div class="d-flex align-items-center mb-3">
                <div class="service-box bg-white text-white me-2">
                    <div class="font-22">
                        <i class="lni lni-checkmark"></i>
                    </div>
                </div>
                <h6 class="mb-0 border-bottom">Asistencia Terapéutica</h6>
            </div>

            <div class="d-flex align-items-center justify-content-start mb-3">
                <!-- Fecha -->
                <div class="text-center bg-white text-primary p-2 rounded shadow-sm me-3" style="width: 70px;">
                    <div class="fw-bold" style="font-size: 1.5rem;">
                        {{ ultima_cita.cita_terapeutica_asignada|date:"d" }}
                    </div>
                    <div style="text-transform: uppercase; font-size: 0.8rem;">
                        {{ ultima_cita.cita_terapeutica_asignada|date:"b" }}
                    </div>
                </div>

                <!-- Hora -->
                <div class="text-center bg-white text-primary p-2 rounded shadow-sm me-3" style="width: 70px;">
                    <div class="fw-bold" style="font-size: 1.5rem;">
                        <i class="lni lni-alarm-clock"></i>
                    </div>
                    <div style="text-transform: uppercase; font-size: 0.8rem;">
                        {{ ultima_cita.hora|default:"—" }}
                    </div>
                </div>

                <!-- Lugar -->
                <div class="text-center bg-white text-primary p-2 rounded shadow-sm me-3" style="width: 70px;">
                    <div class="fw-bold" style="font-size: 1.5rem;">
                        <i class="lni lni-map"></i>
                    </div>
                    <div style="text-transform: uppercase; font-size: 0.8rem;">
                        {{ ultima_cita.sucursal|default:"Sin asignar" }}
                    </div>
                </div>
            </div>

            <!-- Estado -->
            <div>
                <span class="badge p-2
                    {% if ultima_cita.asistire %}
                        bg-success
                    {% else %}
                        bg-warning text-dark
                    {% endif %}
                ">
                    {% if ultima_cita.asistire %}
                        <i class="fadeIn animated bx bx-check-double"></i> Asistencia Confirmada
                    {% else %}
                        <i class="lni lni-checkmark"></i> Asistencia Pendiente
                    {% endif %}
                </span>
            </div>



            <div class="mt-3 pt-2 border-top">
                <p class="mb-0"><strong>Terapéuta:</strong> {{ ultima_cita.terapeuta.get_full_name }}</p>
                <p class="mb-0"><strong>Actividad:</strong> {{ ultima_cita.titulo|default:"Sin título" }}</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

            
{% if ultima_tarea %}
    <div class="col">
        <div class="card radius-10 bg-primary text-white h-100">
            
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="service-box bg-white text-white me-2">
                        <div class="font-22">
                            <i class="lni lni-notepad"></i>
                        </div>
                    </div>
                    <h6 class="mb-0">Tarea Terapéutica Asignada</h6>
                </div>

                <div class="d-flex flex-wrap gap-3 mb-3">
                    <div class="bg-white text-primary text-center p-2 rounded shadow-sm" style="width: 110px;">
                        <small>Enviada</small>
                        <div class="fw-bold">{{ ultima_tarea.fecha_envio|date:"d M Y" }}</div>
                    </div>
                    <div class="bg-white text-primary text-center p-2 rounded shadow-sm" style="width: 110px;">
                        <small>Entrega</small>
                        <div class="fw-bold">{{ ultima_tarea.fecha_entrega|date:"d M Y" }}</div>
                    </div>
                    <div>
                        <span class="badge {% if ultima_tarea.actividad_realizada %}bg-success{% else %}bg-warning text-dark{% endif %} p-2">
                            {% if ultima_tarea.actividad_realizada %}✔ Realizada{% else %}⏳ Pendiente{% endif %}
                        </span>
                    </div>
                </div>

                {% if ultima_tarea.material_adjunto %}
                <p class="mt-3 mb-0">
                    <strong>Material:</strong>
                    <a class="text-white text-decoration-underline" href="{{ ultima_tarea.material_adjunto.url }}" download>Descargar</a>
                </p>
                {% endif %}

                <a href="{% url 'usuarios:ver_tarea' pk=ultima_tarea.pk %}">
                    <div class="d-flex align-items-center theme-icons shadow-sm p-2 cursor-pointer rounded mt-3">
                        <div class="font-22"><ion-icon name="pencil"></ion-icon></div>
                        <div class="ms-2">Realizar Actividad</div>
                    </div>
                </a>

                  <div class="mt-3 pt-2 border-top">
                    <p class="mb-0"><strong> {{ ultima_cita.descripcion_tarea  }} </strong></p>   
                    
                </div>


            </div>

        </div>
    </div>
    {% else %}

            {% endif %}
</div>


    


        </div>
        {% include 'usuarios/panel_usuario2.html' %} 
    </div>
</div>

</div>