{% extends "base.html" %}
{% load widget_tweaks %}
{% load static %}

{% block content %}

<style>
    .terminal-card {
        font-family: 'Courier New', Courier, monospace;
        border: 1px solid #444040;
    }

    .terminal-output {
        height: 220px;
        overflow-y: auto;
        white-space: pre-wrap;
    }

    /* Responsividad */
    @media (max-width: 576px) {
        .terminal-output {
            height: 150px; /* más pequeño para móviles */
            font-size: 5pt;
        }
    }
</style>

<div class="page-content-wrapper">
  <!-- start page content-->
  <div class="page-content">

<!-- Navbar para tabs -->
<!-- Navbar para tabs -->




        <div class="card radius-10">


            <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <div class="border p-3 rounded">
                              
                           



                                <hr>
<h6>Terminal del sistema ITC:  <span class="spinner-border spinner-border-sm text-warning" role="status" aria-hidden="true"></span> {{project.name}}</h6>
                                {% if project.progress == 5 %}
<p id="typewriter" style="color:#fff;font-size: 10px;"></p>
{% endif %}

{% if project.progress == 10 %}
<p id="typewriter-resource" style="color:#fff;font-size: 10px;"></p>
{% endif %}

{% if project.progress == 15 %}
<p id="typewriter-security" style="color:#fff;font-size: 10px;"></p>
{% endif %}

{% if project.progress == 25 %}
<p id="typewriter-nginx" style="color:#fff;font-size: 10px;"></p>
{% endif %}

{% if project.progress == 50 %}
<p id="typewriter-postgres" style="color:#fff;font-size: 10px;"></p>
{% endif %}

{% if project.progress == 75 %}
<p id="typewriter-kafka" style="color:#fff;font-size: 10px;"></p>
{% endif %}

{% if project.progress == 100 %}
<p id="typewriter-redis" style="color:#fff;font-size: 10px;"></p>
{% endif %}


                                <!-- Consola estilo terminal -->
                               <div class="card bg-primary text-success mb-3 terminal-card" style="font-family: 'Courier New', Courier, monospace; border: 1px solid #444040;">
    <div class="card-body p-3" id="terminal-output" 
         style="height: 369px; overflow-y: auto; white-space: pre-wrap;font-size: 10px;">
    </div>
</div>






<div class="progress">
  <div class="progress-bar" role="progressbar"
       style="width: {{ project.progress }}%;
              {% if project.progress == 5 %}
                background-color: #e63946;
              {% elif project.progress == 10 %}
                background-color: #f8961e;
              {% elif project.progress == 50 %}
                background-color: #f9c74f;
              {% elif project.progress == 80 %}
                background-color: #42698a;
              {% elif project.progress == 100 %}
                background-color: #2a9d8f;
              {% else %}
                background-color: #6c757d; /* color por defecto */
              {% endif %}"
       aria-valuenow="{{ project.progress }}"
       aria-valuemin="0"
       aria-valuemax="100">
    {{ project.progress }}%
  </div>
</div>


<hr>


                                <!-- Nombre del Proyecto -->

                                {% if project.progress == 100 %}
                                <!-- Botón de Guardar -->
                                <div class="col-12 mt-4">
                                    <div class="d-grid">
                                                      
<a href="{% url 'business_customer_projects:project_detail' pk=project.id %}" 
   class="btn btn-primary">
    Ir a {{ project.name }} 
    <ion-icon name="chevron-forward-outline"></ion-icon>
</a>

                                    </div>
                                </div>
                                {% endif %}

                            </div>
                        </div>
                    </div>
          
            </div>
        </div>


    <!-- Otras pestañas de contenido pueden ir aquí -->
</div>







  </div> <!-- end page content -->







<script>
document.addEventListener("DOMContentLoaded", function () {

    function typeWriterEffect(elementId, text, speed) {
        let index = 0;
        function type() {
            if (index < text.length) {
                document.getElementById(elementId).innerHTML += text.charAt(index);
                index++;
                setTimeout(type, speed);
            }
        }
        type();
    }

    {% if project.progress == 5 %}
    const text_start = `Estamos iniciando el proceso de generación de tu proyecto IT Cloud Business. Este procedimiento se realiza de forma automatizada mediante nuestros avanzados modelos de inteligencia artificial. En este momento, comenzaremos a desplegar tu sistema de información en tiempo real. Primero, identificaremos los servidores dedicados más adecuados alrededor del mundo para alojar tu sistema de manera óptima. Este proceso tiene una duración aproximada de 30 minutos.`;
    typeWriterEffect("typewriter", text_start, 35);
    {% endif %}

    {% if project.progress == 10 %}
    const text_resource = `Estamos analizando los requisitos técnicos de tu proyecto para seleccionar los recursos de nube óptimos. Nuestro sistema evalúa automáticamente latencia, disponibilidad, costos, rendimiento y cumplimiento normativo en múltiples proveedores globales. Gracias a nuestros modelos de IA, identificamos la región y configuración que maximizan rendimiento, seguridad y escalabilidad para tu IT Cloud Business.`;
    typeWriterEffect("typewriter-resource", text_resource, 25);
    {% endif %}

    {% if project.progress == 15 %}
    const text_security = `Estamos activando la arquitectura de seguridad zero-trust. Esto incluye validación estricta de identidades, rotación dinámica de claves, políticas IAM de mínimo privilegio y cifrado extremo a extremo para proteger cada transacción dentro del sistema. Nuestros protocolos garantizan que solo servicios verificados puedan interactuar entre sí.`;
    typeWriterEffect("typewriter-security", text_security, 25);
    {% endif %}

    {% if project.progress == 25 %}
    const text_nginx = `Estamos configurando el servidor web NGINX, el cual se encargará de gestionar el tráfico entrante y ofrecer un rendimiento óptimo. Durante este proceso se aplican reglas de cacheo, balanceo HTTP/3 QUIC, compresión avanzada y configuración SSL con certificados actualizados para garantizar una conexión segura y estable.`;
    typeWriterEffect("typewriter-nginx", text_nginx, 25);
    {% endif %}

    {% if project.progress == 50 %}
    const text_postgres = `Estamos inicializando la base de datos PostgreSQL. El sistema crea tablas, índices, extensiones criptográficas y habilita la replicación síncrona para garantizar disponibilidad y tolerancia a fallos. También se activa el cifrado en reposo utilizando mecanismos de seguridad basados en AES-256.`;
    typeWriterEffect("typewriter-postgres", text_postgres, 25);
    {% endif %}

    {% if project.progress == 75 %}
    const text_kafka = `Estamos levantando la infraestructura de streaming Apache Kafka, encargada de procesar grandes volúmenes de eventos en tiempo real. Los topics de distribución permiten que diferentes microservicios se comuniquen eficientemente, manteniendo la resiliencia y la consistencia incluso en condiciones de alta demanda.`;
    typeWriterEffect("typewriter-kafka", text_kafka, 25);
    {% endif %}

    {% if project.progress == 100 %}
    const text_redis = `Estamos configurando Redis como capa de cache distribuido para acelerar el acceso a datos críticos y reducir la latencia del sistema. Para mayor seguridad, se habilitan ACL, cifrado de tráfico y algoritmos de compresión de alta eficiencia dentro del clúster.`;
    typeWriterEffect("typewriter-redis", text_redis, 25);
    {% endif %}

});
</script>



<script>
function typeWriterEffect(elementId, text, speed = 35) {
    let index = 0;
    const target = document.getElementById(elementId);

    function write() {
        if (index < text.length) {
            target.innerHTML += text.charAt(index);
            index++;
            setTimeout(write, speed);
        }
    }
    write();
}
</script>







<script>
document.addEventListener("DOMContentLoaded", function () {

    const terminal = document.getElementById("terminal-output");
    const prefix = "# ";

    // Función para colorear según tipo
    function colorize(line, element) {
        if (line.includes("[SUCCESS]")) element.style.color = "#00ff5e";        // VERDE
        else if (line.includes("[INFO]")) element.style.color = "#ffd54f";      // AMARILLO
        else if (line.includes("[OK]")) element.style.color = "#6dffea";        // VERDE CIAN
        else if (line.includes("[SECURITY]")) element.style.color = "#9c7bff";  // MORADO
        else if (line.includes("[SYSTEM]")) element.style.color = "#6ecbff";    // CELESTE
        else if (line.includes("[RESOURCE]")) element.style.color = "#4fe3ff";  // CIAN SUAVE
        else element.style.color = "#ffffff";                                   // DEFAULT
    }

    // BLOQUES DE LOGS POR PORCENTAJE
    const logs_by_progress = [

        { min: 5, logs: [
            prefix + "[RESOURCE] Analizando requerimientos de carga del proyecto IT Cloud Business... (1.4s)",
        ]},

        { min: 10, logs: [
            prefix + "[RESOURCE] Analizando requerimientos de carga del proyecto IT Cloud Business... (1.4s)",
            prefix + "[RESOURCE] Estimando consumo inicial: 2 vCPU, 4GB RAM, 40GB SSD. (214ms)",
            prefix + "[RESOURCE] Predicción IA: carga media proyectada a 90 días: 3.2 vCPU, 6GB RAM. (538ms)",
            prefix + "[RESOURCE] Evaluando proveedores según latencia...",
            prefix + "[RESOURCE] Latencia promedio detectada:",
            prefix + "          AWS Frankfurt: 23ms",
            prefix + "          Azure Zurich: 28ms",
            prefix + "          Google Cloud Bélgica: 19ms",
            prefix + "          Oracle Amsterdam: 31ms",
            prefix + "[OK]  Proveedor con mejor tiempo: Google Cloud (19ms).",
            prefix + "[RESOURCE] Analizando costos estimados por proveedor... (732ms)",
            prefix + "          AWS: $38.12/mes",
            prefix + "          Azure: $41.55/mes",
            prefix + "          GCP: $33.74/mes",
            prefix + "          Oracle: $36.90/mes",
            prefix + "[OK]  Proveedor más eficiente: Google Cloud (GCP).",
            prefix + "[RESOURCE] Verificando disponibilidad regional de GCP... (1.1s)",
            prefix + "[OK]  Región disponible: europe-west1 (Bélgica).",
            prefix + "[RESOURCE] Consultando inventario de máquinas virtuales... (482ms)",
            prefix + "[RESOURCE] Tipos disponibles:",
            prefix + "          e2-medium: 2 vCPU / 4GB RAM",
            prefix + "          e2-standard-2: 2 vCPU / 8GB RAM",
            prefix + "          n2-standard-2: 2 vCPU / 8GB RAM (alto rendimiento)",
            prefix + "[INFO] Comparando rendimiento/costo con predictor IA... (806ms)",
            prefix + "[OK]  Recurso ideal: e2-standard-2 (balance costo-rendimiento).",
            prefix + "[RESOURCE] Verificando disponibilidad de almacenamiento SSD... (412ms)",
            prefix + "[OK]  Disco persistente 40GB listo para aprovisionamiento.",
            prefix + "[SUCCESS] Recurso ideal seleccionado: GCP europe-west1 / e2-standard-2 (2 vCPU, 8GB RAM).",
            prefix + "[SYSTEM] Iniciando aprovisionamiento del recurso seleccionado... (in progress)"
        ]},
        { min: 15, logs: [
            prefix + "[SECURITY] Evaluando cumplimiento normativo según región: GDPR, ISO-27001, SOC2... (1.5s)",
            prefix + "[OK]  Región seleccionada cumple todas las normativas aplicables.",
            prefix + "[RESOURCE] Evaluando redes y balanceadores de carga... (1.3s)",
            prefix + "[OK]  VPC dinámica y load balancer disponibles en región seleccionada.",
            prefix + "[RESOURCE] Verificando capacidad para escalamiento automático (autoscaling)... (662ms)",
            prefix + "[OK]  Autoscaling horizontal configurable de 2 a 10 instancias.",
            prefix + "[RESOURCE] Evaluando redundancia multi-zona...",
            prefix + "[OK]  Zonas activas: europe-west1-b, europe-west1-c.",
            prefix + "[SECURITY] Iniciando protocolo Zero-Trust Network Access (ZTNA)... (1.1s)",
            prefix + "[SECURITY] Cargando políticas IAM de usuario y servicio... (643ms)",
            prefix + "[SECURITY] Validando integridad de tokens JWT... (137ms)",
            prefix + "[SECURITY] Rotando claves de acceso dinámicas... (328ms)",
            prefix + "[OK]  Políticas de seguridad activas y verificadas."
        ]},
        { min: 25, logs: [
            prefix + "[INFO] Iniciando servicio NGINX... (590ms)",
            prefix + "[INFO] Cargando configuración /etc/nginx/nginx.conf... (204ms)",
            prefix + "[SECURITY] Habilitando TLS 1.3 y HTTP/3 QUIC... (376ms)",
            prefix + "[OK]  Certificado SSL cargado: Let's Encrypt R3. (82ms)",
            prefix + "[OK]  NGINX iniciado en el puerto 80 y 443."
        ]},
        { min: 50, logs: [
            prefix + "[INFO] Inicializando base de datos PostgreSQL... (1.7s)",
            prefix + "[INFO] Cargando extensión pgcrypto... (122ms)",
            prefix + "[INFO] Aplicando migraciones automáticas... (3.1s)",
            prefix + "[SECURITY] Activando cifrado en reposo (AES-256)... (288ms)",
            prefix + "[OK]  PostgreSQL listo y escuchando en el puerto 5432.",
            prefix + "[INFO] Verificando replicación... (932ms)",
            prefix + "[OK]  Replicación síncrona activa."
        ]},
        { min: 75, logs: [
            prefix + "[INFO] Iniciando broker Kafka... (1.4s)",
            prefix + "[INFO] Sincronizando particiones... (982ms)",
            prefix + "[SECURITY] Habilitando cifrado TLS para tráfico de brokers... (319ms)",
            prefix + "[OK]  Kafka broker activo en puerto 9092.",
            prefix + "[INFO] Creando topics de streaming... (221ms)",
            prefix + "[OK]  Topic: sq_stream_events creado.",
            prefix + "[OK]  Topic: sq_background_tasks creado."
        ]},
        { min: 100, logs: [
            prefix + "[INFO] Iniciando servidor Redis... (680ms)",
            prefix + "[INFO] Cargando configuraciones de caché...",
            prefix + "[SECURITY] Activando autenticación REDIS ACL... (120ms)",
            prefix + "[OK]  Redis en ejecución: modo cluster-enabled.",
            prefix + "[INFO] Estableciendo TTL inteligente para sesiones... (94ms)",
            prefix + "[OK]  Caché funcional."
        ]}
    ];

    let block_index = 0;
    let line_index = 0;

    function writeLogsByProgress() {
        if (block_index >= logs_by_progress.length) return;

        const block = logs_by_progress[block_index];

        // Solo mostrar bloque si project.progress alcanza el mínimo
        if ({{ project.progress }} >= block.min) {
            if (line_index < block.logs.length) {
                const line = document.createElement("p");
                line.classList.add("mb-0");
                line.textContent = block.logs[line_index];
                colorize(block.logs[line_index], line);

                terminal.appendChild(line);
                terminal.scrollTop = terminal.scrollHeight;

                line_index++;
                setTimeout(writeLogsByProgress, Math.random() * 500 + 300);
            } else {
                block_index++;
                line_index = 0;
                writeLogsByProgress();
            }
        }
    }

    writeLogsByProgress();

});
</script>



{% endblock %}
