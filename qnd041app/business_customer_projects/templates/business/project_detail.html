{% extends "base.html" %}
{% load widget_tweaks %}
{% load static %}

{% block content %}

<div class="page-content-wrapper">
  <!-- start page content-->
  <div class="page-content">

<!-- Nav pills -->
<ul class="nav nav-pills mb-3" id="custom-tabs" role="tablist">
  <li class="nav-item" role="presentation">
    <a class="nav-link active" data-bs-toggle="pill" href="#tab-general" role="tab" aria-selected="true">
      <div class="d-flex align-items-center">
        <div class="tab-icon"><i class="bx bx-folder font-18 me-1"></i></div>
        <div class="tab-title">{{ project.name }}</div>
      </div>
    </a>
  </li>

  <li class="nav-item" role="presentation">
    <a class="nav-link" data-bs-toggle="pill" href="#tab-desarrollo" role="tab" aria-selected="false">
      <div class="d-flex align-items-center">
        <div class="tab-icon"><ion-icon name="code-slash-outline"></ion-icon></div>
        <div class="tab-title">(I+D)</div>
      </div>
    </a>
  </li>

  {% if has_automation %}
  <li class="nav-item" role="presentation">
    <a class="nav-link" data-bs-toggle="pill" href="#tab-automatizacion" role="tab" aria-selected="false">
      <div class="d-flex align-items-center">
        <div class="tab-icon"><i class="bx bx-bot font-18 me-1"></i></div>
        <div class="tab-title">(+A)</div>
      </div>
    </a>
  </li>
  {% endif %}

  {% if has_ai %}
  <li class="nav-item" role="presentation">
    <a class="nav-link" data-bs-toggle="pill" href="#tab-ia" role="tab" aria-selected="false">
      <div class="d-flex align-items-center">
        <div class="tab-icon"><i class="bx bx-brain font-18 me-1"></i></div>
        <div class="tab-title">(+AI)</div>
      </div>
    </a>
  </li>
  {% endif %}

  <li class="nav-item" role="presentation">
    <a class="nav-link" data-bs-toggle="pill" href="#tab-recursos" role="tab" aria-selected="false">
      <div class="d-flex align-items-center">
        <div class="tab-icon"><ion-icon name="hardware-chip-outline"></ion-icon></div>
        <div class="tab-title"></div>
      </div>
    </a>
  </li>
</ul>


    <div class="tab-content">

      <!-- TAB 1: Información General del Proyecto -->
      <div class="tab-pane fade show active" id="tab-general" role="tabpanel">
        <div class="card radius-10">
          <div class="card-body">
            <h3>{{ project.name }}</h3>
            <p><strong>Descripción:</strong> {{ project.description }}</p>
            <p><strong>Fecha de Creación:</strong> {{ project.created_at|date:"d/m/Y H:i" }}</p>

            <hr class="my-4">

            <h4>SmartQuail Crew  Asignado</h4>

        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-3 row-cols-xxl-3">
  {% for member in staff %}
    <div class="col">
      <div class="card radius-10">
        <div class="card-body text-center">
          <div class="profile-img">
            {% if member.profile_picture %}
              <img src="{{ member.profile_picture.url }}" class="rounded-circle" width="120" height="120" alt="{{ member.full_name }}">
            {% else %}
              <img src="{% static 'images/default-profile.png' %}" class="rounded-circle" width="120" height="120" alt="Sin foto">
            {% endif %}
          </div>
          <div class="mt-4">
            <h5 class="mb-1">{{ member.full_name }}</h5>
            <p class="mb-0">{{ member.get_role_display }}</p>
          </div>
          <div class="d-flex align-items-center justify-content-around mt-4">
            <div class="">
              <h6 class="mb-0">{{ member.email }}</h6>
              <p class="mb-0 text-muted">Correo</p>
            </div>
            <div class="">
              <h6 class="mb-0">{{ member.phone }}</h6>
              <p class="mb-0 text-muted">Teléfono</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <p class="text-muted">No hay miembros asignados al proyecto.</p>
  {% endfor %}
</div>


            {% if staff %}
              <ul class="list-group">
              {% for person in staff %}
                <li class="list-group-item">
                  <strong>{{ person.name }}</strong> – {{ person.role }}
                  <br><small>Email: {{ person.email }}</small>
                </li>
              {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">No hay personal asignado al proyecto.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- TAB 2: Desarrollo e Investigación -->
<div class="tab-pane fade" id="tab-desarrollo" role="tabpanel">
  {% for process in processes %}
  <div class="card mb-4 radius-10">
    <div class="card-header py-2">
      <div class="row row-cols-1 row-cols-lg-3">
        <div class="col">
          <small>Información del Proceso</small>
          <address class="m-t-5 m-b-5">
            <strong class="text-inverse">{{ process.name }}</strong><br>
            <small>{{ process.description }}</small><br>
            <strong>Progreso:</strong> {{ process.progress }}%<br>
            <strong>Tipo:</strong> {{ process.get_process_type_display }}<br>
            <strong>Clase:</strong> {{ process.get_process_class_display }}
          </address>
        </div>
        <div class="col">
          <small>Fechas</small>
          <address class="m-t-5 m-b-5">
            <strong>Inicio:</strong> {{ process.start_date|date:"d/m/Y" }}<br>
            <strong>Entrega:</strong> {{ process.delivery_date|date:"d/m/Y" }}<br>
            <strong>Días desarrollo:</strong> {{ process.total_development_days }} días<br>
            <strong>Aprobado:</strong> {{ process.approved_by_client|yesno:"Sí,No" }}
          </address>
        </div>
        <div class="col">
          <small>Automatización e IA</small>
          <div class="m-t-5 m-b-5">
            <strong>Automatización:</strong> {{ process.has_automation|yesno:"Sí,No" }}{% if process.has_automation %} - {{ process.automation_description }}{% endif %}<br>
            <strong>¿Usa IA?:</strong> {{ process.has_ai|yesno:"Sí,No" }}{% if process.has_ai %} - {{ process.ai_model_description }}{% endif %}
          </div>
        </div>
      </div>
    </div>

<div class="card-body">

  {% if process.progress == 100 %}
    <!-- Solo botón para visualizar -->
    {% if process.final_url %}
      <div class="text-center my-5">
        <a href="{{ process.final_url }}" target="_blank" class="btn btn-primary btn-lg">
          Visualizar Resultado Final
        </a>
      </div>
    {% else %}
      <p class="text-center text-warning my-5">No hay URL final disponible.</p>
    {% endif %}
  {% else %}
    <!-- Mostrar tabla con todos los detalles -->
    <div class="table-responsive">
      <table class="table table-invoice">
        <thead>
          <tr>
            <th>Descripción</th>
            <th class="text-center" width="15%">Tecnología</th>
            <th class="text-center" width="20%">Desarrollador</th>
            <th class="text-center" width="15%">QA Tests</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <span class="text-inverse">Detalles</span><br>
              <small>{{ process.description }}</small>
            </td>
            <td class="text-center">
              <span class="badge bg-info">{{ process.technology_type }}</span>
            </td>
            <td class="text-center">
              {% if process.assigned_developer %}
              <div class="d-flex flex-column align-items-center">
                <img src="{% if process.assigned_developer.profile_picture %}{{ process.assigned_developer.profile_picture.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" 
                     class="rounded-circle mb-1" width="40" height="40" alt="Foto perfil">
                <small><strong>{{ process.assigned_developer.full_name }}</strong></small>
                <small>{{ process.assigned_developer.get_role_display }}</small>
              </div>
              {% else %}
              <small class="text-muted"><em>No asignado</em></small>
              {% endif %}
            </td>
            <td class="text-center">
              {% if process.qa_tests.exists %}
                <ul class="list-unstyled small mb-0">
                  {% for test in process.qa_tests.all %}
                  <li>
                    <span class="badge {% if test.result == 'passed' %}bg-success{% elif test.result == 'failed' %}bg-danger{% else %}bg-warning text-dark{% endif %} mb-1">
                      {{ test.get_result_display }}
                    </span><br>
                    <small>{{ test.test_case }}</small>
                  </li>
                  {% endfor %}
                </ul>
              {% else %}
                <small class="text-muted">Sin pruebas QA</small>
              {% endif %}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Ejemplo de resumen -->
    <div class="row bg-light align-items-center m-0">
      <div class="col col-auto p-3">
        <p class="mb-0" style="color:#fff;">Progreso</p>
        <div class="progress" style="height: 6px;">
          <div class="progress-bar bg-gradient-purple" role="progressbar" style="width: {{ process.progress }}%;"></div>
        </div>
        <p class="mb-0" style="color:#fff;">{{ process.progress }}%</p>
      </div>
      <div class="col col-auto me-auto p-3">
        <p class="mb-0" style="color:#fff;">Días totales</p>
        <h5 class="mb-0">{{ process.total_development_days }} días</h5>
      </div>
      <div class="col bg-primary col-auto p-3">
        <p class="mb-0 text-white">Aprobado</p>
        <h5 class="mb-0 text-white">{{ process.approved_by_client|yesno:"Sí,No" }}</h5>
      </div>
    </div>

    <hr>

    <div class="my-3 small text-muted">
      * Información sujeta a cambios según el avance del proyecto.<br>
      * Contactar con el administrador para más detalles.
    </div>
  {% endif %}
</div>

  </div>
  {% empty %}
  <p>No hay procesos definidos para este proyecto.</p>
  {% endfor %}
</div>





      <!-- TAB 3: Recursos y Facturación -->
      <div class="tab-pane fade" id="tab-recursos" role="tabpanel">
        <div class="card radius-10">
          <div class="card-body">
            <h4 class="mb-3"><ion-icon name="hardware-chip-outline"></ion-icon> Recursos Cloud</h4>
            {% for resource in cloud_resources %}
            <div class="card mb-3 border">
              <div class="card-body">
                <h5>{{ resource.resource_name }} ({{ resource.provider }})</h5>
                <p><strong>Tipo:</strong> {{ resource.get_resource_type_display }}</p>
                <p><strong>Costo Mensual:</strong> ${{ resource.monthly_cost_usd }}</p>
                <p><strong>Monitoreo:</strong> {{ resource.monitoring_tool|default:"No especificado" }}</p>
                <p><strong>Estado:</strong> 
                  <span class="badge 
                    {% if resource.monitoring_status == 'healthy' %} bg-success 
                    {% elif resource.monitoring_status == 'warning' %} bg-warning text-dark 
                    {% else %} bg-danger 
                    {% endif %}">
                    {{ resource.get_monitoring_status_display }}
                  </span>
                </p>
                {% if resource.alert_summary %}
                <p><strong>Alertas:</strong> {{ resource.alert_summary }}</p>
                {% endif %}
              </div>
            </div>
            {% empty %}
            <p>No hay recursos cloud asignados a este proyecto.</p>
            {% endfor %}
          </div>
        </div>
      </div>


{% if has_automation %}
<div class="tab-pane fade" id="tab-automatizacion" role="tabpanel">
  {% for process in processes %}
    {% if process.has_automation %}
    <div class="card mb-4 radius-10">
      <div class="card-header py-2">
        <div class="row row-cols-1 row-cols-lg-3">
          <div class="col">
            <small>Información de Automatización</small>
            <address class="m-t-5 m-b-5">
              <strong class="text-inverse">{{ process.name }}</strong><br>
              <small>{{ process.description }}</small><br>
              <strong>Automatización:</strong> {{ process.automation_description }}
            </address>
          </div>
          <div class="col">
            <small>Fechas</small>
            <address class="m-t-5 m-b-5">
              <strong>Inicio:</strong> {{ process.start_date|date:"d/m/Y" }}<br>
              <strong>Entrega:</strong> {{ process.delivery_date|date:"d/m/Y" }}<br>
              <strong>Días desarrollo:</strong> {{ process.total_development_days }} días<br>
              <strong>Aprobado:</strong> {{ process.approved_by_client|yesno:"Sí,No" }}
            </address>
          </div>
          <div class="col">
            <small>Desarrollador</small>
            <address class="m-t-5 m-b-5 text-center">
              {% if process.assigned_developer %}
                <img src="{% if process.assigned_developer.profile_picture %}{{ process.assigned_developer.profile_picture.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" 
                     class="rounded-circle mb-1" width="50" height="50" alt="Foto perfil">
                <br>
                <strong>{{ process.assigned_developer.full_name }}</strong><br>
                <small>{{ process.assigned_developer.get_role_display }}</small>
              {% else %}
                <small class="text-muted"><em>No asignado</em></small>
              {% endif %}
            </address>
          </div>
        </div>
      </div>

      <div class="card-body">
        {% if process.progress == 100 %}
          {% if process.final_url %}
            <div class="text-center my-5">
              <a href="{{ process.final_url }}" target="_blank" class="btn btn-primary btn-lg">
                Visualizar Resultado Final
              </a>
            </div>
          {% else %}
            <p class="text-center text-warning my-5">No hay URL final disponible.</p>
          {% endif %}
        {% else %}
          <div class="table-responsive">
            <table class="table table-invoice">
              <thead>
                <tr>
                  <th>Descripción</th>
                  <th class="text-center" width="25%">Tecnología</th>
                  <th class="text-center" width="20%">Desarrollador</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <span class="text-inverse">Detalles</span><br>
                    <small>{{ process.description }}</small>
                  </td>
                  <td class="text-center">
                    <span class="badge bg-info">{{ process.technology_type }}</span>
                  </td>
                  <td class="text-center">
                    {% if process.assigned_developer %}
                    <div class="d-flex flex-column align-items-center">
                      <img src="{% if process.assigned_developer.profile_picture %}{{ process.assigned_developer.profile_picture.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" 
                           class="rounded-circle mb-1" width="40" height="40" alt="Foto perfil">
                      <small><strong>{{ process.assigned_developer.full_name }}</strong></small>
                      <small>{{ process.assigned_developer.get_role_display }}</small>
                    </div>
                    {% else %}
                    <small class="text-muted"><em>No asignado</em></small>
                    {% endif %}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="row bg-light align-items-center m-0">
            <div class="col col-auto p-3">
              <p class="mb-0" style="color:#fff;">Progreso</p>
              <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-gradient-purple" role="progressbar" style="width: {{ process.progress }}%;"></div>
              </div>
              <p class="mb-0" style="color:#fff;">{{ process.progress }}%</p>
            </div>
            <div class="col col-auto me-auto p-3">
              <p class="mb-0" style="color:#fff;">Días totales</p>
              <h5 class="mb-0">{{ process.total_development_days }} días</h5>
            </div>
            <div class="col bg-primary col-auto p-3">
              <p class="mb-0 text-white">Aprobado</p>
              <h5 class="mb-0 text-white">{{ process.approved_by_client|yesno:"Sí,No" }}</h5>
            </div>
          </div>

          <hr>

          <div class="my-3 small text-muted">
            * Información sujeta a cambios según el avance del proyecto.<br>
            * Contactar con el administrador para más detalles.
          </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  {% empty %}
  <p>No hay procesos con automatización.</p>
  {% endfor %}
</div>
{% endif %}



{% if has_ai %}
<div class="tab-pane fade" id="tab-ia" role="tabpanel">
  {% for ai in intelligents %}
  <div class="card mb-4 radius-10">
    <div class="card-header py-2">
      <div class="row row-cols-1 row-cols-lg-3">
        <div class="col">
          <small>Información del Modelo</small>
          <address class="m-t-5 m-b-5">
            <strong class="text-inverse">{{ ai.name }}</strong><br>
            <small>{{ ai.description }}</small><br>
            <strong>Tipo IA:</strong> {{ ai.get_ai_type_display }}<br>
            <strong>GPU:</strong> {{ ai.requires_gpu|yesno:"Sí,No" }}<br>
            {% if ai.model_accuracy %}
              <strong>Precisión:</strong> {{ ai.model_accuracy }}%
            {% endif %}
          </address>
        </div>
        <div class="col">
          <small>Fechas</small>
          <address class="m-t-5 m-b-5">
            <strong>Inicio:</strong> {{ ai.start_date|date:"d/m/Y" }}<br>
            <strong>Entrega:</strong> {{ ai.delivery_date|date:"d/m/Y" }}<br>
            <strong>Días desarrollo:</strong> {{ ai.total_development_days }} días<br>
            <strong>Aprobado:</strong> {{ ai.approved_by_client|yesno:"Sí,No" }}
          </address>
        </div>
        <div class="col">
          <small>Desarrollador</small>
          <address class="m-t-5 m-b-5 text-center">
            {% if ai.assigned_developer %}
              <img src="{% if ai.assigned_developer.profile_picture %}{{ ai.assigned_developer.profile_picture.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" 
                   class="rounded-circle mb-1" width="50" height="50" alt="Foto perfil">
              <br>
              <strong>{{ ai.assigned_developer.full_name }}</strong><br>
              <small>{{ ai.assigned_developer.get_role_display }}</small>
            {% else %}
              <small class="text-muted"><em>No asignado</em></small>
            {% endif %}
          </address>
        </div>
      </div>
    </div>

    <div class="card-body">
      {% if ai.progress == 100 %}
        {% if ai.final_url %}
          <div class="text-center my-5">
            <a href="{{ ai.final_url }}" target="_blank" class="btn btn-primary btn-lg">
              Visualizar Resultado Final
            </a>
          </div>
        {% else %}
          <p class="text-center text-warning my-5">No hay URL final disponible.</p>
        {% endif %}
      {% else %}
        <div class="table-responsive">
          <table class="table table-invoice">
            <thead>
              <tr>
                <th>Notas Técnicas</th>
                <th class="text-center" width="25%">Mapas de Decisión</th>
                <th class="text-center" width="20%">Desarrollador</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  {% if ai.technical_notes %}
                  <span class="text-inverse">Notas Técnicas</span><br>
                  <small>{{ ai.technical_notes|linebreaksbr }}</small>
                  {% else %}
                  <small class="text-muted">No disponible.</small>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if ai.decision_maps %}
                  <span class="text-inverse">Mapas de Decisión</span><br>
                  <small>{{ ai.decision_maps|linebreaksbr }}</small>
                  {% else %}
                  <small class="text-muted">No disponible.</small>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if ai.assigned_developer %}
                  <div class="d-flex flex-column align-items-center">
                    <img src="{% if ai.assigned_developer.profile_picture %}{{ ai.assigned_developer.profile_picture.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" 
                         class="rounded-circle mb-1" width="40" height="40" alt="Foto perfil">
                    <small><strong>{{ ai.assigned_developer.full_name }}</strong></small>
                    <small>{{ ai.assigned_developer.get_role_display }}</small>
                  </div>
                  {% else %}
                  <small class="text-muted"><em>No asignado</em></small>
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="row bg-light align-items-center m-0">
          <div class="col col-auto p-3">
            <p class="mb-0" style="color:#fff;">Progreso</p>
            <div class="progress" style="height: 6px;">
              <div class="progress-bar bg-gradient-purple" role="progressbar" style="width: {{ ai.progress }}%;"></div>
            </div>
            <p class="mb-0" style="color:#fff;">{{ ai.progress }}%</p>
          </div>
          <div class="col col-auto me-auto p-3">
            <p class="mb-0" style="color:#fff;">Días totales</p>
            <h5 class="mb-0">{{ ai.total_development_days }} días</h5>
          </div>
          <div class="col bg-primary col-auto p-3">
            <p class="mb-0 text-white">Aprobado</p>
            <h5 class="mb-0 text-white">{{ ai.approved_by_client|yesno:"Sí,No" }}</h5>
          </div>
        </div>

        <hr>

        <div class="my-3 small text-muted">
          * Información sujeta a cambios según el avance del proyecto.<br>
          * Contactar con el administrador para más detalles.
        </div>
      {% endif %}
    </div>
  </div>
  {% empty %}
  <p>No hay inteligencias artificiales registradas para este proyecto.</p>
  {% endfor %}
</div>
{% endif %}








    </div> <!-- end tab content -->

  </div> <!-- end page content -->
</div>

{% endblock %}
