{% load widget_tweaks %}
{% load static %}

<div class="tab-pane fade" id="tab-desarrollo" role="tabpanel">

    <hr class="my-4">
    <div class="card radius-10">
        <div class="card-body">
            <div class="row">
                <!-- IZQUIERDA: Procesos -->
                <div class="col-12 col-xl-8 d-flex">
                    <div class="card radius-10 w-100">
                        <div class="card-body" style="background-color: rgb(46, 46, 46); border-radius: 25px;">
                            
                            <div class="country-icon mb-3">
                                <img src="assets/images/icons/india.png" alt="" width="32">
                            </div>

                            <h5>Investigación y Desarrollo: {{ project.name }}</h5>

                            <!-- TARJETAS DE ESTADÍSTICAS -->
                            <div class="d-flex flex-column flex-lg-row align-items-lg-center align-self-end justify-content-lg-between border p-3 gap-3 mb-0 rounded-3">

                                <!-- Total Procesos -->
                                <div class="d-flex align-items-center gap-3">
                                    <div class="widget-icon rounded-circle bg-light-success text-success">
                                        <ion-icon name="git-network-outline"></ion-icon>
                                    </div>
                                    <div>
                                        <h4 class="mb-0">{{ total }}</h4>
                                        <p class="mb-0 text-secondary">Total Procesos</p>
                                    </div>
                                </div>

                                <div class="vr d-none d-lg-block"></div>

                                <!-- En Desarrollo -->
                                <div class="d-flex align-items-center gap-3">
                                    <div class="widget-icon rounded-circle bg-light-success text-success">
                                        <ion-icon name="code-slash-outline"></ion-icon>
                                    </div>
                                    <div>
                                        <h4 class="mb-0">{{ in_progress }}</h4>
                                        <p class="mb-0 text-secondary">En Desarrollo ({{ average_progress }}%)</p>
                                    </div>
                                </div>

                                <div class="vr d-none d-lg-block"></div>

                                <!-- Completados -->
                                <div class="d-flex align-items-center gap-3">
                                    <div class="widget-icon rounded-circle bg-light-success text-success">
                                        <ion-icon name="checkmark-done-outline"></ion-icon>
                                    </div>
                                    <div>
                                        <h4 class="mb-0">{{ completed }}</h4>
                                        <p class="mb-0 text-secondary">Completados</p>
                                    </div>
                                </div>
                            </div>

                            <!-- LISTA DE PROCESOS -->
                            <div class="row g-4 align-items-center mb-4">
                                <div class="col-12 col-xl-12" style="max-height: 300px; overflow-y: auto; margin-top: 79px;">
                                    {% for member in staff %}
                                        {% for process in member.assigned_processes.all %}
                                        <div class="d-flex align-items-start mb-3">

                                            <!-- Foto del miembro -->
                                            <div class="review-user">
                                                {% if member.profile_picture %}
                                                    <img src="{{ member.profile_picture.url }}" class="rounded-circle" width="60" height="60" alt="{{ member.full_name }}">
                                                {% else %}
                                                    <img src="{% static 'images/default-profile.png' %}" class="rounded-circle" width="60" height="60" alt="Sin foto">
                                                {% endif %}
                                            </div>

                                            <!-- Contenido del proceso -->
                                            <div class="review-content ms-3 flex-grow-1">

                                                <!-- Barra de progreso -->
                                                <div class="progress mb-2" style="height:7px;">
                                                    <div class="progress-bar progress-bar-striped bg-warning" role="progressbar"
                                                         style="width: {{ process.progress }}%" aria-valuenow="{{ process.progress }}" aria-valuemin="0" aria-valuemax="100">
                                                    </div>
                                                </div>

                                                <div class="d-flex align-items-center mb-1">
                                                    <h6 class="mb-0">{{ process.name }}
                                                        <ion-icon name="git-network-outline"></ion-icon>

                                                        {% if process.progress == 100 %}
                                                            <ion-icon name="checkmark-done-circle-outline"></ion-icon>
                                                        {% else %}
                                                            <span class="spinner-border spinner-border-sm text-warning"></span>
                                                        {% endif %}
                                                    </h6>
                                                </div>

                                                <div class="d-flex align-items-center mb-1">
                                                    <h6 class="mb-0">Fecha de creación:</h6>
                                                    <p class="mb-0 ms-2">{{ process.start_date|date:"d/m/Y" }}</p>
                                                </div>

                                                <p>{{ process.description|default:"Sin descripción" }}</p>
                                            </div>
                                        </div>
                                        <hr/>
                                        {% endfor %}
                                    {% empty %}
                                        <p>No hay miembros del staff o procesos asignados.</p>
                                    {% endfor %}
                                </div>
                            </div><!-- end row -->

                        </div>
                    </div>
                </div>

                <!-- DERECHA: Staff -->
                <div class="col-12 col-xl-4 d-flex">
                    <div class="card radius-10 overflow-hidden w-100">
                        <div class="card-body" style="background-color: rgb(46, 46, 46); border-radius: 25px;">

                            <div class="card radius-10 w-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <h5 class="mb-0">Equipo SmartQuail Responsable</h5>
                                    </div>

                                    <!-- CONTENEDOR HORIZONTAL -->
                                    <div class="d-flex gap-4 flex-wrap">
                                        {% for member in staff %}
                                        <div class="review-user text-center">
                                            {% if member.profile_picture %}
                                                <img src="{{ member.profile_picture.url }}" width="65" height="65" class="rounded-circle" alt="{{ member.full_name }}">
                                            {% else %}
                                                <img src="{% static 'images/default-profile.png' %}" class="rounded-circle" width="65" height="65" alt="Sin foto">
                                            {% endif %}
                                            <p class="mb-0 fw-bold" style="font-size: 13px;">{{ member.full_name }}</p>
                                            <p class="mb-0 text-muted" style="font-size: 9px;">{{ member.get_role_display }}</p>
                                        </div>
                                        {% empty %}
                                            <p class="text-muted">No hay miembros asignados al proyecto.</p>
                                        {% endfor %}
                                    </div>
                                    <!-- FIN CONTENEDOR HORIZONTAL -->

                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-4">
        </div>
    </div>
</div>
