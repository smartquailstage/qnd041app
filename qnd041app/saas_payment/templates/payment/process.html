{% extends "saas_shop/base3.html" %}

{% block title %}Selecciona método de pago{% endblock %}

{% block content %}


<style>
  .step-count-circle {
  background-color: #b50f15; /* o el color corporativo que uses */
  color: #fff;
  width: 28px;
  height: 28px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  font-weight: 600;
  margin-right: 8px;
  font-size: 14px;
}

</style>

<div class="page-content-wrapper">
          <!-- start page content-->
         <div class="page-content">


<div class="product-more-info mt-4">



<div class="card">
  <div class="card-body p-4" style="color: #ededed; text-align: justify; font-family: 'Segoe UI', sans-serif; font-size: 14px; line-height: 1.2; background-color: #403c3c; border-radius: 25px;">

    <!-- Progreso de pasos -->
    <div class="card border-0 bg-transparent">
      <div class="card-body">
        <div class="steps steps-light">
          <a class="step-item active" href="#">
            <div class="step-progress"><span class="step-count">1</span></div>
          </a>
          <a class="step-item active " href="{% url 'saas_orders:order_detail' order_id=order.id %}" >
            <div class="step-progress"><span class="step-count">2</span></div>
          </a>
          <a class="step-item active current"  href="#" ><div class="step-progress"><span class="step-count">3</span></div></a>
          <a class="step-item"><div class="step-progress"><span class="step-count">4</span></div></a>
        </div>
      </div>
    </div>

    <!-- Checkout Section -->
    <section class="shop-page">
      <div class="shop-container">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <div class="shop-cart">
              <div class="row">
                <div class="col-12 col-xl-8">
                  <div class="checkout-details">
                    <div class="card">
                      <div class="card-header border-bottom" style="color:#fff">
                        <h2 class="h5 mb-0">
                          <span class="step-count-circle">3</span> Método de Pago
                        </h2>
                        <p class="mt-2">
                          Por favor, seleccione el método de pago que considere más adecuado para realizar el abono correspondiente a los servicios de software y recursos contratados. Una vez confirmado el pago, se enviará a su correo electrónico los siguientes documentos:
                        </p>
                        <ul>
                          <li><strong>Contrato de Propiedad Intelectual</strong></li>
                          <li><strong>Contrato de Servicios de Desarrollo y Consultoría</strong></li>
                          <li><strong>Contrato de Alquiler de Servicios en la Nube</strong></li>
                        </ul>
                      </div>
                      <div class="card-body">
                        <!-- Tabs -->
                        <ul class="nav nav-tabs" id="paymentTabs" role="tablist">
                          <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="card-tab" data-bs-toggle="tab" href="#card" role="tab">Tarjeta</a>
                          </li>
                          <li class="nav-item" role="presentation">
                            <a class="nav-link" id="paypal-tab" data-bs-toggle="tab" href="#paypal" role="tab">PayPal</a>
                          </li>
                          <li class="nav-item" role="presentation">
                            <a class="nav-link" id="bank-tab" data-bs-toggle="tab" href="#bank" role="tab">Transferencia</a>
                          </li>
                        </ul>

                        <div class="tab-content pt-3" id="paymentTabsContent">
                          <!-- Tarjeta -->
                          <div class="tab-pane fade show active" id="card" role="tabpanel">
                            <form id="payment" action="." method="post">
                              {% csrf_token %}
                              <div class="mb-3">
                                <label class="form-label">Número de Tarjeta</label>
                                <div id="card-number" class="form-control"></div>
                              </div>
                              <div class="mb-3">
                                <label class="form-label">CVV</label>
                                <div id="cvv" class="form-control"></div>
                              </div>
                              <div class="mb-3">
                                <label class="form-label">Fecha de Expiración</label>
                                <div id="expiration-date" class="form-control"></div>
                              </div>
                              <input type="hidden" name="payment_method_nonce" id="nonce">
                              <div class="d-grid">
								    <h5 class="mb-0">Total a Pagar: <span class="float-end">${{ order.get_total_cost }}</span></h5>
                                <input type="submit" value="Confirmar Pago" class="btn btn-primary btn-ecomm">
                              </div>
                            </form>
                          </div>

                          <!-- PayPal -->
                          <div class="tab-pane fade" id="paypal" role="tabpanel">
                            <form action='.' method="post">
                              {% csrf_token %}
                              <p>Serás redirigido a PayPal para completar el pago.</p>
                              <div class="d-grid">
								<h5 class="mb-0">Total a Pagar: <span class="float-end">${{ order.get_total_cost }}</span></h5>
                                <button type="submit" class="btn btn-warning btn-ecomm">Pagar con PayPal</button>
                              </div>
                            </form>
                          </div>

                          <!-- Transferencia Bancaria -->
                          <div class="tab-pane fade" id="bank" role="tabpanel">
                            <form action='.' method="post">
                              {% csrf_token %}
                              <div class="mb-3">
                                <label for="token" class="form-label">Token de Transacción</label>
                                <input type="text" name="token" id="token" class="form-control" placeholder="Token generado por Kushki">
                              </div>
                              <div class="d-grid">
								    <h5 class="mb-0">Total a Pagar: <span class="float-end">${{ order.get_total_cost }}</span></h5>
                                <button type="submit" class="btn btn-success btn-ecomm">Pagar por Transferencia</button>
                              </div>
                            </form>
                          </div>
                        </div>
                        <!-- End Tabs -->
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Order Summary -->

                <!-- End Order Summary -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>
</div>



    </div>


      </div>
  </div>


{% endblock %}

{% block script %}
<!-- Braintree SDK -->
<script src="https://js.braintreegateway.com/web/3.29.0/js/client.min.js"></script>
<script src="https://js.braintreegateway.com/web/3.29.0/js/hosted-fields.min.js"></script>

<script>
	document.addEventListener('DOMContentLoaded', function () {
		let hostedFieldsInitialized = false;

		function initBraintree() {
			if (hostedFieldsInitialized) return;

			braintree.client.create({
				authorization: '{{ client_token }}'
			}, function (clientErr, clientInstance) {
				if (clientErr) {
					console.error("Error creando cliente Braintree:", clientErr);
					return;
				}

				braintree.hostedFields.create({
					client: clientInstance,
					styles: {
						'input': {'font-size': '13px'},
						'input.invalid': {'color': 'red'},
						'input.valid': {'color': 'green'}
					},
					fields: {
						number: { selector: '#card-number' },
						cvv: { selector: '#cvv' },
						expirationDate: { selector: '#expiration-date' }
					}
				}, function (hostedFieldsErr, hostedFieldsInstance) {
					if (hostedFieldsErr) {
						console.error("Error creando Hosted Fields:", hostedFieldsErr);
						return;
					}

					hostedFieldsInitialized = true;
					const form = document.getElementById('payment');
					const submit = form.querySelector('input[type="submit"]');

					form.addEventListener('submit', function (event) {
						event.preventDefault();

						hostedFieldsInstance.tokenize(function (tokenizeErr, payload) {
							if (tokenizeErr) {
								console.error("Error al tokenizar:", tokenizeErr);
								alert("Verifica los datos de la tarjeta.");
								return;
							}

							document.getElementById('nonce').value = payload.nonce;
							form.submit();
						});
					});
				});
			});
		}

		// Escuchamos cuando se activa la pestaña de tarjeta
		const cardTabTrigger = document.querySelector('[href="#card"]');
		if (cardTabTrigger) {
			cardTabTrigger.addEventListener('shown.bs.tab', function () {
				setTimeout(initBraintree, 100);  // pequeña espera para asegurarse que es visible
			});
		}

		// Si ya está activa al cargar
		const cardTab = document.getElementById('card');
		if (cardTab && cardTab.classList.contains('show')) {
			initBraintree();
		}
	});
</script>


{% endblock %}


