{% extends "saas_shop/base.html" %}

{% block title %}Selecciona método de pago{% endblock %}

{% block content %}
<div class="page-content-wrapper">
	<div class="page-content">

		<!-- Breadcrumb -->
		<div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
			<div class="breadcrumb-title pe-3">Software como Producto</div>
			<div class="ps-3">
				<nav aria-label="breadcrumb">
					<ol class="breadcrumb mb-0 p-0 align-items-center">
						<li class="breadcrumb-item active" aria-current="page">Pasarela de Pagos</li>
					</ol>
				</nav>
			</div>
		</div>
		<!-- End Breadcrumb -->

		<!-- Checkout Section -->
		<section class="shop-page">
			<div class="shop-container">
				<div class="card shadow-sm border-0">
					<div class="card-body">
						<div class="shop-cart">
							<div class="row">
								<div class="col-12 col-xl-8">
									<div class="checkout-details">

										<div class="card">
											<div class="card-header border-bottom">
												<h2 class="h5">Escoja el método de pago</h2>
											</div>

											<div class="card-body">

												<!-- Tabs -->
												<ul class="nav nav-tabs" id="paymentTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <a class="nav-link active" id="card-tab" data-bs-toggle="tab" href="#card" role="tab">Tarjeta</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" id="paypal-tab" data-bs-toggle="tab" href="#paypal" role="tab">PayPal</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" id="bank-tab" data-bs-toggle="tab" href="#bank" role="tab">Transferencia</a>
  </li>
</ul>


                        

												<div class="tab-content pt-3" id="paymentTabsContent">
													<!-- Tarjeta -->
													<div class="tab-pane fade show active" id="card" role="tabpanel">
														<form id="payment" action="." method="post">
															{% csrf_token %}
															<div class="mb-3">
																<label class="form-label">Número de Tarjeta</label>
																<div id="card-number" class="form-control"></div>
															</div>
															<div class="mb-3">
																<label class="form-label">CVV</label>
																<div id="cvv" class="form-control"></div>
															</div>
															<div class="mb-3">
																<label class="form-label">Fecha de Expiración</label>
																<div id="expiration-date" class="form-control"></div>
															</div>
															<input type="hidden" name="payment_method_nonce" id="nonce">
															<div class="d-grid">
																<input type="submit" value="Confirmar Pago" class="btn btn-primary btn-ecomm">
															</div>
														</form>
													</div>

													<!-- PayPal -->
													<div class="tab-pane fade" id="paypal" role="tabpanel">
														<form action='.' method="post">
															{% csrf_token %}
															<p>Serás redirigido a PayPal para completar el pago.</p>
															<div class="d-grid">
																<button type="submit" class="btn btn-warning btn-ecomm">Pagar con PayPal</button>
															</div>
														</form>
													</div>

													<!-- Transferencia Bancaria -->
													<div class="tab-pane fade" id="bank" role="tabpanel">
														<form action='.' method="post">
															{% csrf_token %}
															<div class="mb-3">
																<label for="token" class="form-label">Token de Transacción</label>
																<input type="text" name="token" id="token" class="form-control" placeholder="Token generado por Kushki">
															</div>
															<div class="d-grid">
																<button type="submit" class="btn btn-success btn-ecomm">Pagar por Transferencia</button>
															</div>
														</form>
													</div>
												</div>
												<!-- End Tabs -->

											</div>
										</div>

										<div class="card mt-3">
											<div class="card-body">
												<div class="row">
													<div class="col-md-6">
														<div class="d-grid"><a href="javascript:;" class="btn btn-light btn-ecomm"><i class="bx bx-chevron-left"></i>Volver</a></div>
													</div>
													<div class="col-md-6">
														<div class="d-grid"><a href="javascript:;" class="btn btn-white btn-ecomm">Revisar Pedido<i class="bx bx-chevron-right"></i></a></div>
													</div>
												</div>
											</div>
										</div>

									</div>
								</div>

								<!-- Order Summary -->
								<div class="col-12 col-xl-4">
									<div class="order-summary">
										<div class="card">
											<div class="card-body">
												<p class="mb-2">Subtotal: <span class="float-end">${{ order.get_total_cost }}</span></p>
												<p class="mb-2">Envío: <span class="float-end">--</span></p>
												<p class="mb-2">Impuestos: <span class="float-end">--</span></p>
												<p class="mb-0">Descuento: <span class="float-end">--</span></p>
												<div class="my-3 border-top"></div>
												<h5 class="mb-0">Total: <span class="float-end">${{ order.get_total_cost }}</span></h5>
											</div>
										</div>
									</div>
								</div>
								<!-- End Order Summary -->

							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
		<!-- End Checkout Section -->

	</div>
</div>
{% endblock %}

{% block script %}
<!-- Braintree SDK -->
<script src="https://js.braintreegateway.com/web/3.29.0/js/client.min.js"></script>
<script src="https://js.braintreegateway.com/web/3.29.0/js/hosted-fields.min.js"></script>

<script>
	document.addEventListener('DOMContentLoaded', function () {
		let hostedFieldsInitialized = false;

		function initBraintree() {
			if (hostedFieldsInitialized) return;

			braintree.client.create({
				authorization: '{{ client_token }}'
			}, function (clientErr, clientInstance) {
				if (clientErr) {
					console.error("Error creando cliente Braintree:", clientErr);
					return;
				}

				braintree.hostedFields.create({
					client: clientInstance,
					styles: {
						'input': {'font-size': '13px'},
						'input.invalid': {'color': 'red'},
						'input.valid': {'color': 'green'}
					},
					fields: {
						number: { selector: '#card-number' },
						cvv: { selector: '#cvv' },
						expirationDate: { selector: '#expiration-date' }
					}
				}, function (hostedFieldsErr, hostedFieldsInstance) {
					if (hostedFieldsErr) {
						console.error("Error creando Hosted Fields:", hostedFieldsErr);
						return;
					}

					hostedFieldsInitialized = true;
					const form = document.getElementById('payment');
					const submit = form.querySelector('input[type="submit"]');

					form.addEventListener('submit', function (event) {
						event.preventDefault();

						hostedFieldsInstance.tokenize(function (tokenizeErr, payload) {
							if (tokenizeErr) {
								console.error("Error al tokenizar:", tokenizeErr);
								alert("Verifica los datos de la tarjeta.");
								return;
							}

							document.getElementById('nonce').value = payload.nonce;
							form.submit();
						});
					});
				});
			});
		}

		// Escuchamos cuando se activa la pestaña de tarjeta
		const cardTabTrigger = document.querySelector('[href="#card"]');
		if (cardTabTrigger) {
			cardTabTrigger.addEventListener('shown.bs.tab', function () {
				setTimeout(initBraintree, 100);  // pequeña espera para asegurarse que es visible
			});
		}

		// Si ya está activa al cargar
		const cardTab = document.getElementById('card');
		if (cardTab && cardTab.classList.contains('show')) {
			initBraintree();
		}
	});
</script>


{% endblock %}
