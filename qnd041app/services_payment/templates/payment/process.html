{% extends "saas_shop/base3.html" %}

{% block title %}Selecciona método de pago{% endblock %}

{% block content %}

<style>
  .step-count-circle {
    background-color: #b50f15;
    color: #fff;
    width: 28px;
    height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-weight: 600;
    margin-right: 8px;
    font-size: 14px;
  }
</style>

<div class="page-content-wrapper">
  <div class="page-content">

    <div class="product-more-info mt-4">

      <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item" role="presentation">
          <a class="nav-link active" id="tab-order" data-bs-toggle="tab" href="#order" role="tab" aria-controls="order" aria-selected="true">
            <div class="d-flex align-items-center">
              <div class="tab-title text-uppercase fw-500"><ion-icon name="card-outline"></ion-icon></div>
            </div>
          </a>
        </li>
      </ul>

      <div class="card">
        <div class="card-body p-4" style="color: #ededed; text-align: justify; font-family: 'Segoe UI', sans-serif; font-size: 14px; line-height: 1.2; background-color: #403c3c; border-radius: 25px;">

          <!-- Progreso de pasos -->
          <div class="card border-0 bg-transparent">
            <div class="card-body">
              <div class="steps steps-light">
                <a class="step-item active" href="#"><div class="step-progress"><span class="step-count">1</span></div></a>
                <a class="step-item active" href="#"><div class="step-progress"><span class="step-count">2</span></div></a>
                <a class="step-item active current" href="#"><div class="step-progress"><span class="step-count">3</span></div></a>
                <a class="step-item"><div class="step-progress"><span class="step-count">4</span></div></a>
              </div>
            </div>
          </div>

          <!-- Checkout Section -->
          <section class="shop-page">
            <div class="shop-container">
              <div class="card shadow-sm border-0">
                <div class="card-body">
                  <div class="shop-cart">

                    <!-- Lista de productos del carrito -->
                    <h4>Resumen del carrito</h4>
                    <table class="table table-dark table-striped">
                      <thead>
                        <tr>
                          <th>Servicio</th>
                          <th>Proyecto</th>
                          <th>Precio unitario</th>
                          <th>Cantidad</th>
                          <th>Total</th>
                        </tr>
                      </thead>
                      <tbody>
{% for item in cart %}
    {% with order=item.product %}
        <tr>
            <td>{{ order.get_service_type_display }}</td>
            <td>{{ order.project|default:"-" }}</td>
            <td>${{ item.price|floatformat:2 }}</td>
            <td>{{ item.quantity }}</td>
            <td>${{ item.total_price|floatformat:2 }}</td>
        </tr>
    {% endwith %}
{% endfor %}

                      </tbody>
                    </table>

                    <h5 class="text-end">Total a pagar: ${{ total_amount|floatformat:2 }}</h5>

                    <!-- Tabs de métodos de pago -->
                    <ul class="nav nav-tabs" id="paymentTabs" role="tablist">
                      <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="card-tab" data-bs-toggle="tab" href="#card" role="tab">Tarjeta</a>
                      </li>
                      <li class="nav-item" role="presentation">
                        <a class="nav-link" id="paypal-tab" data-bs-toggle="tab" href="#paypal" role="tab">PayPal</a>
                      </li>
                      <li class="nav-item" role="presentation">
                        <a class="nav-link" id="bank-tab" data-bs-toggle="tab" href="#bank" role="tab">Transferencia</a>
                      </li>
                    </ul>

                    <div class="tab-content pt-3" id="paymentTabsContent">

                      <!-- Tarjeta -->
                      <div class="tab-pane fade show active" id="card" role="tabpanel">
                        <form id="payment" action="." method="post">
                          {% csrf_token %}
                          <div class="form-group">
                            <label>Card Number</label>
                            <div id="card-number"></div>
                          </div>
                          <div class="form-group row">
                            <div class="col-xs-4">
                              <label>CVV</label>
                              <div id="cvv"></div>
                            </div>
                            <div class="col-xs-4">
                              <label>Exp. Month</label>
                              <div id="expiration-date"></div>
                            </div>
                          </div>
                          <input type="hidden" name="payment_method_nonce" id="nonce">
                          <div class="d-grid mt-3">
                            <input type="submit" value="Confirmar Pago" class="btn btn-primary btn-ecomm">
                          </div>
                        </form>
                      </div>

                      <!-- PayPal -->
                      <div class="tab-pane fade" id="paypal" role="tabpanel">
                        <form action="." method="post">
                          {% csrf_token %}
                          <p>Serás redirigido a PayPal para completar el pago.</p>
                          <div class="d-grid">
                            <button type="submit" class="btn btn-warning btn-ecomm">
                              <ion-icon name="card-outline"></ion-icon> Pagar con PayPal
                            </button>
                          </div>
                        </form>
                      </div>

                      <!-- Transferencia Bancaria -->
                      <div class="tab-pane fade" id="bank" role="tabpanel">
                        <form action="." method="post">
                          {% csrf_token %}
                          <div class="mb-3">
                            <label for="token" class="form-label">Token de Transacción</label>
                            <input type="text" name="token" id="token" class="form-control" placeholder="Token generado por Kushki">
                          </div>
                          <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-ecomm">
                              <ion-icon name="card-outline"></ion-icon> Pagar por Transferencia
                            </button>
                          </div>
                        </form>
                      </div>

                    </div>
                    <!-- End Tabs -->

                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>
      </div>

    </div>

  </div>
</div>

{% endblock %}

{% block script %}
<script src="https://js.braintreegateway.com/web/3.29.0/js/client.min.js"></script>
<script src="https://js.braintreegateway.com/web/3.29.0/js/hosted-fields.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  braintree.client.create({ authorization: '{{ client_token }}' }, function (clientErr, clientInstance) {
    if (clientErr) { console.error(clientErr); return; }

    braintree.hostedFields.create({
      client: clientInstance,
      styles: {'input': {'font-size':'13px'}, 'input.invalid':{'color':'red'}, 'input.valid':{'color':'green'}},
      fields: {
        number: { selector: '#card-number' },
        cvv: { selector: '#cvv' },
        expirationDate: { selector: '#expiration-date' }
      }
    }, function (hostedFieldsErr, hostedFieldsInstance) {
      if (hostedFieldsErr) { console.error(hostedFieldsErr); return; }

      const form = document.getElementById('payment');
      form.addEventListener('submit', function (event) {
        event.preventDefault();
        hostedFieldsInstance.tokenize(function (tokenizeErr, payload) {
          if (tokenizeErr) { alert("Verifica los datos de la tarjeta."); return; }
          document.getElementById('nonce').value = payload.nonce;
          form.submit();
        });
      });
    });
  });
});
</script>
{% endblock %}
